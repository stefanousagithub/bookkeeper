<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InMemoryMetastoreTable.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache BookKeeper :: Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.metastore</a> &gt; <span class="el_source">InMemoryMetastoreTable.java</span></div><h1>InMemoryMetastoreTable.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.bookkeeper.metastore;

import com.google.common.util.concurrent.ThreadFactoryBuilder;
import java.util.NavigableMap;
import java.util.Set;
import java.util.TreeMap;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import org.apache.bookkeeper.metastore.MSException.Code;
import org.apache.bookkeeper.versioning.Version;
import org.apache.bookkeeper.versioning.Versioned;

/**
 * An in-memory implementation of a Metastore table.
 */
public class InMemoryMetastoreTable implements MetastoreScannableTable {

    /**
     * An implementation of the Version interface for metadata.
     */
    public static class MetadataVersion implements Version {
        int version;

<span class="nc" id="L41">        public MetadataVersion(int v) {</span>
<span class="nc" id="L42">            this.version = v;</span>
<span class="nc" id="L43">        }</span>

<span class="nc" id="L45">        public MetadataVersion(MetadataVersion v) {</span>
<span class="nc" id="L46">            this.version = v.version;</span>
<span class="nc" id="L47">        }</span>

        public synchronized MetadataVersion incrementVersion() {
<span class="nc" id="L50">            ++version;</span>
<span class="nc" id="L51">            return this;</span>
        }

        @Override
        public Occurred compare(Version v) {
<span class="nc bnc" id="L56" title="All 2 branches missed.">            if (null == v) {</span>
<span class="nc" id="L57">                throw new NullPointerException(&quot;Version is not allowed to be null.&quot;);</span>
            }
<span class="nc bnc" id="L59" title="All 2 branches missed.">            if (v == Version.NEW) {</span>
<span class="nc" id="L60">                return Occurred.AFTER;</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            } else if (v == Version.ANY) {</span>
<span class="nc" id="L62">                return Occurred.CONCURRENTLY;</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            } else if (!(v instanceof MetadataVersion)) {</span>
<span class="nc" id="L64">                throw new IllegalArgumentException(&quot;Invalid version type&quot;);</span>
            }
<span class="nc" id="L66">            MetadataVersion mv = (MetadataVersion) v;</span>
<span class="nc" id="L67">            int res = version - mv.version;</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">            if (res == 0) {</span>
<span class="nc" id="L69">                return Occurred.CONCURRENTLY;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            } else if (res &lt; 0) {</span>
<span class="nc" id="L71">                return Occurred.BEFORE;</span>
            } else {
<span class="nc" id="L73">                return Occurred.AFTER;</span>
            }
        }

        @Override
        public boolean equals(Object obj) {
<span class="nc bnc" id="L79" title="All 4 branches missed.">            if (null == obj || !(obj instanceof MetadataVersion)) {</span>
<span class="nc" id="L80">                return false;</span>
            }
<span class="nc" id="L82">            MetadataVersion v = (MetadataVersion) obj;</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">            return 0 == (version - v.version);</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L88">            return &quot;version=&quot; + version;</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L93">            return version;</span>
        }
    }

    private String name;
<span class="nc" id="L98">    private TreeMap&lt;String, Versioned&lt;Value&gt;&gt; map = null;</span>
<span class="nc" id="L99">    private TreeMap&lt;String, MetastoreWatcher&gt; watcherMap = null;</span>
    private ScheduledExecutorService scheduler;

<span class="nc" id="L102">    public InMemoryMetastoreTable(InMemoryMetaStore metastore, String name) {</span>
<span class="nc" id="L103">        this.map = new TreeMap&lt;String, Versioned&lt;Value&gt;&gt;();</span>
<span class="nc" id="L104">        this.watcherMap = new TreeMap&lt;String, MetastoreWatcher&gt;();</span>
<span class="nc" id="L105">        this.name = name;</span>
<span class="nc" id="L106">        String thName = &quot;InMemoryMetastore-Table(&quot; + name + &quot;)-Scheduler-%d&quot;;</span>
<span class="nc" id="L107">        ThreadFactoryBuilder tfb = new ThreadFactoryBuilder()</span>
<span class="nc" id="L108">                .setNameFormat(thName);</span>
<span class="nc" id="L109">        this.scheduler = Executors</span>
<span class="nc" id="L110">                .newSingleThreadScheduledExecutor(tfb.build());</span>
<span class="nc" id="L111">    }</span>

    @Override
    public String getName () {
<span class="nc" id="L115">        return this.name;</span>
    }

    static Versioned&lt;Value&gt; cloneValue(Value value, Version version, Set&lt;String&gt; fields) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (null != value) {</span>
<span class="nc" id="L120">            Value newValue = new Value();</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (ALL_FIELDS == fields) {</span>
<span class="nc" id="L122">                fields = value.getFields();</span>
            }
<span class="nc bnc" id="L124" title="All 2 branches missed.">            for (String f : fields) {</span>
<span class="nc" id="L125">                newValue.setField(f, value.getField(f));</span>
<span class="nc" id="L126">            }</span>
<span class="nc" id="L127">            value = newValue;</span>
        }

<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (null == version) {</span>
<span class="nc" id="L131">            throw new NullPointerException(&quot;Version isn't allowed to be null.&quot;);</span>
        }
<span class="nc bnc" id="L133" title="All 4 branches missed.">        if (Version.ANY != version &amp;&amp; Version.NEW != version) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            if (version instanceof MetadataVersion) {</span>
<span class="nc" id="L135">                version = new MetadataVersion(((MetadataVersion) version).version);</span>
            } else {
<span class="nc" id="L137">                throw new IllegalStateException(&quot;Wrong version type.&quot;);</span>
            }
        }
<span class="nc" id="L140">        return new Versioned&lt;Value&gt;(value, version);</span>
    }

    @Override
    public void get(final String key, final MetastoreCallback&lt;Versioned&lt;Value&gt;&gt; cb, final Object ctx) {
<span class="nc" id="L145">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L148">                scheduleGet(key, ALL_FIELDS, cb, ctx);</span>
<span class="nc" id="L149">            }</span>
        });
<span class="nc" id="L151">    }</span>

    @Override
    public void get(final String key, final MetastoreWatcher watcher, final MetastoreCallback&lt;Versioned&lt;Value&gt;&gt; cb,
            final Object ctx) {
<span class="nc" id="L156">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L159">                scheduleGet(key, ALL_FIELDS, cb, ctx);</span>
<span class="nc" id="L160">                synchronized (watcherMap) {</span>
<span class="nc" id="L161">                    watcherMap.put(key, watcher);</span>
<span class="nc" id="L162">                }</span>
<span class="nc" id="L163">            }</span>
        });
<span class="nc" id="L165">    }</span>

    @Override
    public void get(final String key, final Set&lt;String&gt; fields, final MetastoreCallback&lt;Versioned&lt;Value&gt;&gt; cb,
            final Object ctx) {
<span class="nc" id="L170">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L173">                scheduleGet(key, fields, cb, ctx);</span>
<span class="nc" id="L174">            }</span>
        });
<span class="nc" id="L176">    }</span>

    public synchronized void scheduleGet(String key, Set&lt;String&gt; fields, MetastoreCallback&lt;Versioned&lt;Value&gt;&gt; cb,
            Object ctx) {
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (null == key) {</span>
<span class="nc" id="L181">            cb.complete(Code.IllegalOp.getCode(), null, ctx);</span>
<span class="nc" id="L182">            return;</span>
        }
<span class="nc" id="L184">        Versioned&lt;Value&gt; vv = get(key);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        int rc = null == vv ? Code.NoKey.getCode() : Code.OK.getCode();</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (vv != null) {</span>
<span class="nc" id="L187">            vv = cloneValue(vv.getValue(), vv.getVersion(), fields);</span>
        }
<span class="nc" id="L189">        cb.complete(rc, vv, ctx);</span>
<span class="nc" id="L190">    }</span>

    @Override
    public void put(final String key, final Value value, final Version version, final MetastoreCallback&lt;Version&gt; cb,
            final Object ctx) {
<span class="nc" id="L195">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc bnc" id="L198" title="All 6 branches missed.">                if (null == key || null == value || null == version) {</span>
<span class="nc" id="L199">                    cb.complete(Code.IllegalOp.getCode(), null, ctx);</span>
<span class="nc" id="L200">                    return;</span>
                }
<span class="nc" id="L202">                Result&lt;Version&gt; result = put(key, value, version);</span>
<span class="nc" id="L203">                cb.complete(result.code.getCode(), result.value, ctx);</span>

                /*
                 * If there is a watcher set for this key, we need
                 * to trigger it.
                 */
<span class="nc bnc" id="L209" title="All 2 branches missed.">                if (result.code == MSException.Code.OK) {</span>
<span class="nc" id="L210">                    triggerWatch(key, MSWatchedEvent.EventType.CHANGED);</span>
                }
<span class="nc" id="L212">            }</span>
        });
<span class="nc" id="L214">    }</span>

    @Override
    public void remove(final String key, final Version version, final MetastoreCallback&lt;Void&gt; cb, final Object ctx) {
<span class="nc" id="L218">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc bnc" id="L221" title="All 4 branches missed.">                if (null == key || null == version) {</span>
<span class="nc" id="L222">                    cb.complete(Code.IllegalOp.getCode(), null, ctx);</span>
<span class="nc" id="L223">                    return;</span>
                }
<span class="nc" id="L225">                Code code = remove(key, version);</span>
<span class="nc" id="L226">                cb.complete(code.getCode(), null, ctx);</span>

<span class="nc bnc" id="L228" title="All 2 branches missed.">                if (code == MSException.Code.OK) {</span>
<span class="nc" id="L229">                    triggerWatch(key, MSWatchedEvent.EventType.REMOVED);</span>
                }
<span class="nc" id="L231">            }</span>
        });
<span class="nc" id="L233">    }</span>

    @Override
    public void openCursor(MetastoreCallback&lt;MetastoreCursor&gt; cb, Object ctx) {
<span class="nc" id="L237">        openCursor(EMPTY_START_KEY, true, EMPTY_END_KEY, true, Order.ASC,</span>
                   ALL_FIELDS, cb, ctx);
<span class="nc" id="L239">    }</span>

    @Override
    public void openCursor(Set&lt;String&gt; fields,
                           MetastoreCallback&lt;MetastoreCursor&gt; cb, Object ctx) {
<span class="nc" id="L244">        openCursor(EMPTY_START_KEY, true, EMPTY_END_KEY, true, Order.ASC,</span>
                   fields, cb, ctx);
<span class="nc" id="L246">    }</span>

    @Override
    public void openCursor(String firstKey, boolean firstInclusive,
                           String lastKey, boolean lastInclusive,
                           Order order, MetastoreCallback&lt;MetastoreCursor&gt; cb,
                           Object ctx) {
<span class="nc" id="L253">        openCursor(firstKey, firstInclusive, lastKey, lastInclusive,</span>
                   order, ALL_FIELDS, cb, ctx);
<span class="nc" id="L255">    }</span>

    @Override
    public void openCursor(final String firstKey, final boolean firstInclusive,
                           final String lastKey, final boolean lastInclusive,
                           final Order order, final Set&lt;String&gt; fields,
                           final MetastoreCallback&lt;MetastoreCursor&gt; cb, final Object ctx) {
<span class="nc" id="L262">        scheduler.submit(new Runnable() {</span>
            @Override
            public void run() {
<span class="nc" id="L265">                Result&lt;MetastoreCursor&gt; result = openCursor(firstKey, firstInclusive, lastKey, lastInclusive,</span>
                        order, fields);
<span class="nc" id="L267">                cb.complete(result.code.getCode(), result.value, ctx);</span>
<span class="nc" id="L268">            }</span>
        });
<span class="nc" id="L270">    }</span>

    private void triggerWatch(String key, MSWatchedEvent.EventType type) {
<span class="nc" id="L273">        synchronized (watcherMap){</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (watcherMap.containsKey(key)) {</span>
<span class="nc" id="L275">                MSWatchedEvent event = new MSWatchedEvent(key, type);</span>
<span class="nc" id="L276">                watcherMap.get(key).process(event);</span>
<span class="nc" id="L277">                watcherMap.remove(key);</span>
            }
<span class="nc" id="L279">        }</span>
<span class="nc" id="L280">    }</span>

    private synchronized Versioned&lt;Value&gt; get(String key) {
<span class="nc" id="L283">        return map.get(key);</span>
    }

    private synchronized Code remove(String key, Version version) {
<span class="nc" id="L287">        Versioned&lt;Value&gt; vv = map.get(key);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (null == vv) {</span>
<span class="nc" id="L289">            return Code.NoKey;</span>
        }
<span class="nc bnc" id="L291" title="All 2 branches missed.">        if (Version.Occurred.CONCURRENTLY != vv.getVersion().compare(version)) {</span>
<span class="nc" id="L292">            return Code.BadVersion;</span>
        }
<span class="nc" id="L294">        map.remove(key);</span>
<span class="nc" id="L295">        return Code.OK;</span>
    }

    static class Result&lt;T&gt; {
        Code code;
        T value;

<span class="nc" id="L302">        public Result(Code code, T value) {</span>
<span class="nc" id="L303">            this.code = code;</span>
<span class="nc" id="L304">            this.value = value;</span>
<span class="nc" id="L305">        }</span>
    }

    private synchronized Result&lt;Version&gt; put(String key, Value value, Version version) {
<span class="nc" id="L309">        Versioned&lt;Value&gt; vv = map.get(key);</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (vv == null) {</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">            if (Version.NEW != version) {</span>
<span class="nc" id="L312">                return new Result&lt;Version&gt;(Code.NoKey, null);</span>
            }
<span class="nc" id="L314">            vv = cloneValue(value, version, ALL_FIELDS);</span>
<span class="nc" id="L315">            vv.setVersion(new MetadataVersion(0));</span>
<span class="nc" id="L316">            map.put(key, vv);</span>
<span class="nc" id="L317">            return new Result&lt;Version&gt;(Code.OK, new MetadataVersion(0));</span>
        }
<span class="nc bnc" id="L319" title="All 2 branches missed.">        if (Version.NEW == version) {</span>
<span class="nc" id="L320">            return new Result&lt;Version&gt;(Code.KeyExists, null);</span>
        }
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (Version.Occurred.CONCURRENTLY != vv.getVersion().compare(version)) {</span>
<span class="nc" id="L323">            return new Result&lt;Version&gt;(Code.BadVersion, null);</span>
        }
<span class="nc" id="L325">        vv.setVersion(((MetadataVersion) vv.getVersion()).incrementVersion());</span>
<span class="nc" id="L326">        vv.setValue(vv.getValue().merge(value));</span>
<span class="nc" id="L327">        return new Result&lt;Version&gt;(Code.OK, new MetadataVersion((MetadataVersion) vv.getVersion()));</span>
    }

    private synchronized Result&lt;MetastoreCursor&gt; openCursor(
            String firstKey, boolean firstInclusive,
            String lastKey, boolean lastInclusive,
            Order order, Set&lt;String&gt; fields) {
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (0 == map.size()) {</span>
<span class="nc" id="L335">            return new Result&lt;MetastoreCursor&gt;(Code.OK, MetastoreCursor.EMPTY_CURSOR);</span>
        }

<span class="nc" id="L338">        boolean isLegalCursor = false;</span>
<span class="nc" id="L339">        NavigableMap&lt;String, Versioned&lt;Value&gt;&gt; myMap = null;</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (Order.ASC == order) {</span>
<span class="nc" id="L341">            myMap = map;</span>
<span class="nc bnc" id="L342" title="All 4 branches missed.">            if (EMPTY_END_KEY == lastKey || lastKey.compareTo(myMap.lastKey()) &gt; 0) {</span>
<span class="nc" id="L343">                lastKey = myMap.lastKey();</span>
<span class="nc" id="L344">                lastInclusive = true;</span>
            }
<span class="nc bnc" id="L346" title="All 4 branches missed.">            if (EMPTY_START_KEY == firstKey || firstKey.compareTo(myMap.firstKey()) &lt; 0) {</span>
<span class="nc" id="L347">                firstKey = myMap.firstKey();</span>
<span class="nc" id="L348">                firstInclusive = true;</span>
            }
<span class="nc bnc" id="L350" title="All 2 branches missed.">            if (firstKey.compareTo(lastKey) &lt;= 0) {</span>
<span class="nc" id="L351">                isLegalCursor = true;</span>
            }
<span class="nc bnc" id="L353" title="All 2 branches missed.">        } else if (Order.DESC == order) {</span>
<span class="nc" id="L354">            myMap = map.descendingMap();</span>
<span class="nc bnc" id="L355" title="All 4 branches missed.">            if (EMPTY_START_KEY == lastKey || lastKey.compareTo(myMap.lastKey()) &lt; 0) {</span>
<span class="nc" id="L356">                lastKey = myMap.lastKey();</span>
<span class="nc" id="L357">                lastInclusive = true;</span>
            }
<span class="nc bnc" id="L359" title="All 4 branches missed.">            if (EMPTY_END_KEY == firstKey || firstKey.compareTo(myMap.firstKey()) &gt; 0) {</span>
<span class="nc" id="L360">                firstKey = myMap.firstKey();</span>
<span class="nc" id="L361">                firstInclusive = true;</span>
            }
<span class="nc bnc" id="L363" title="All 2 branches missed.">            if (firstKey.compareTo(lastKey) &gt;= 0) {</span>
<span class="nc" id="L364">                isLegalCursor = true;</span>
            }
        }

<span class="nc bnc" id="L368" title="All 4 branches missed.">        if (!isLegalCursor || null == myMap) {</span>
<span class="nc" id="L369">            return new Result&lt;MetastoreCursor&gt;(Code.IllegalOp, null);</span>
        }
<span class="nc" id="L371">        MetastoreCursor cursor = new InMemoryMetastoreCursor(</span>
<span class="nc" id="L372">                myMap.subMap(firstKey, firstInclusive, lastKey, lastInclusive), fields, scheduler);</span>
<span class="nc" id="L373">        return new Result&lt;MetastoreCursor&gt;(Code.OK, cursor);</span>
    }

    @Override
    public void close() {
        // do nothing
<span class="nc" id="L379">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>