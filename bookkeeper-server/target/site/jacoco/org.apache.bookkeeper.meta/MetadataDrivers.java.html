<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MetadataDrivers.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache BookKeeper :: Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.meta</a> &gt; <span class="el_source">MetadataDrivers.java</span></div><h1>MetadataDrivers.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
package org.apache.bookkeeper.meta;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.base.Preconditions.checkNotNull;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.collect.Sets;
import com.google.common.util.concurrent.UncheckedExecutionException;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import java.net.URI;
import java.util.Collections;
import java.util.Optional;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ScheduledExecutorService;
import java.util.function.Function;
import lombok.AccessLevel;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.ToString;
import lombok.extern.slf4j.Slf4j;
import org.apache.bookkeeper.common.util.ReflectionUtils;
import org.apache.bookkeeper.conf.ClientConfiguration;
import org.apache.bookkeeper.conf.ServerConfiguration;
import org.apache.bookkeeper.discover.RegistrationManager;
import org.apache.bookkeeper.meta.exceptions.Code;
import org.apache.bookkeeper.meta.exceptions.MetadataException;
import org.apache.bookkeeper.stats.NullStatsLogger;
import org.apache.commons.configuration.ConfigurationException;
import org.apache.commons.lang3.StringUtils;

/**
 * A driver manager for managing a set of metadata drivers.
 *
 */
@NoArgsConstructor(access = AccessLevel.PRIVATE)
<span class="nc" id="L57">@Slf4j</span>
public final class MetadataDrivers {

    static final String ZK_CLIENT_DRIVER_CLASS = &quot;org.apache.bookkeeper.meta.zk.ZKMetadataClientDriver&quot;;
    static final String ZK_BOOKIE_DRIVER_CLASS = &quot;org.apache.bookkeeper.meta.zk.ZKMetadataBookieDriver&quot;;
    static final String BK_METADATA_CLIENT_DRIVERS_PROPERTY = &quot;bookkeeper.metadata.client.drivers&quot;;
    static final String BK_METADATA_BOOKIE_DRIVERS_PROPERTY = &quot;bookkeeper.metadata.bookie.drivers&quot;;

<span class="nc" id="L65">    @ToString</span>
    static class MetadataClientDriverInfo {

        final Class&lt;? extends MetadataClientDriver&gt; driverClass;
        final String driverClassName;

<span class="nc" id="L71">        MetadataClientDriverInfo(Class&lt;? extends MetadataClientDriver&gt; driverClass) {</span>
<span class="nc" id="L72">            this.driverClass = driverClass;</span>
<span class="nc" id="L73">            this.driverClassName = driverClass.getName();</span>
<span class="nc" id="L74">        }</span>

    }

<span class="nc" id="L78">    @ToString</span>
    static class MetadataBookieDriverInfo {

        final Class&lt;? extends MetadataBookieDriver&gt; driverClass;
        final String driverClassName;

<span class="nc" id="L84">        MetadataBookieDriverInfo(Class&lt;? extends MetadataBookieDriver&gt; driverClass) {</span>
<span class="nc" id="L85">            this.driverClass = driverClass;</span>
<span class="nc" id="L86">            this.driverClassName = driverClass.getName();</span>
<span class="nc" id="L87">        }</span>

    }

<span class="nc" id="L91">    @Getter(AccessLevel.PACKAGE)</span>
    private static final ConcurrentMap&lt;String, MetadataClientDriverInfo&gt; clientDrivers;
<span class="nc" id="L93">    @Getter(AccessLevel.PACKAGE)</span>
    private static final ConcurrentMap&lt;String, MetadataBookieDriverInfo&gt; bookieDrivers;

    static {
<span class="nc" id="L97">        clientDrivers = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L98">        bookieDrivers = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L99">        loadInitialDrivers();</span>
<span class="nc" id="L100">    }</span>

    @VisibleForTesting
    static void loadInitialDrivers() {
<span class="nc" id="L104">        loadInitialClientDrivers();</span>
<span class="nc" id="L105">        loadInitialBookieDrivers();</span>
<span class="nc" id="L106">        log.info(&quot;BookKeeper metadata driver manager initialized&quot;);</span>
<span class="nc" id="L107">    }</span>

    private static void loadInitialClientDrivers() {
<span class="nc" id="L110">        Set&lt;String&gt; driverList = Sets.newHashSet();</span>

        // add default zookeeper based driver
<span class="nc" id="L113">        driverList.add(ZK_CLIENT_DRIVER_CLASS);</span>

        // load drivers from system property
<span class="nc" id="L116">        String driversStr = System.getProperty(BK_METADATA_CLIENT_DRIVERS_PROPERTY);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (null != driversStr) {</span>
<span class="nc" id="L118">            String[] driversArray = StringUtils.split(driversStr, ':');</span>
<span class="nc" id="L119">            Collections.addAll(driverList, driversArray);</span>
        }

        // initialize the drivers
<span class="nc bnc" id="L123" title="All 2 branches missed.">        for (String driverClsName : driverList) {</span>
            try {
<span class="nc" id="L125">                MetadataClientDriver driver =</span>
<span class="nc" id="L126">                    ReflectionUtils.newInstance(driverClsName, MetadataClientDriver.class);</span>
<span class="nc" id="L127">                MetadataClientDriverInfo driverInfo =</span>
<span class="nc" id="L128">                    new MetadataClientDriverInfo(driver.getClass());</span>
<span class="nc" id="L129">                clientDrivers.put(driver.getScheme().toLowerCase(), driverInfo);</span>
<span class="nc" id="L130">            } catch (Exception e) {</span>
<span class="nc" id="L131">                log.warn(&quot;Failed to load metadata client driver {}&quot;, driverClsName, e);</span>
<span class="nc" id="L132">            }</span>
<span class="nc" id="L133">        }</span>
<span class="nc" id="L134">    }</span>

    private static void loadInitialBookieDrivers() {
<span class="nc" id="L137">        Set&lt;String&gt; driverList = Sets.newHashSet();</span>

        // add default zookeeper based driver
<span class="nc" id="L140">        driverList.add(ZK_BOOKIE_DRIVER_CLASS);</span>

        // load drivers from system property
<span class="nc" id="L143">        String driversStr = System.getProperty(BK_METADATA_BOOKIE_DRIVERS_PROPERTY);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (null != driversStr) {</span>
<span class="nc" id="L145">            String[] driversArray = StringUtils.split(driversStr, ':');</span>
<span class="nc" id="L146">            Collections.addAll(driverList, driversArray);</span>
        }

        // initialize the drivers
<span class="nc bnc" id="L150" title="All 2 branches missed.">        for (String driverClsName : driverList) {</span>
            try {
<span class="nc" id="L152">                MetadataBookieDriver driver =</span>
<span class="nc" id="L153">                    ReflectionUtils.newInstance(driverClsName, MetadataBookieDriver.class);</span>
<span class="nc" id="L154">                MetadataBookieDriverInfo driverInfo =</span>
<span class="nc" id="L155">                    new MetadataBookieDriverInfo(driver.getClass());</span>
<span class="nc" id="L156">                bookieDrivers.put(driver.getScheme().toLowerCase(), driverInfo);</span>
<span class="nc" id="L157">            } catch (Exception e) {</span>
<span class="nc" id="L158">                log.warn(&quot;Failed to load metadata bookie driver {}&quot;, driverClsName, e);</span>
<span class="nc" id="L159">            }</span>
<span class="nc" id="L160">        }</span>
<span class="nc" id="L161">    }</span>

    /**
     * Register the metadata client {@code driver}.
     *
     * @param metadataBackendScheme scheme of metadata backend.
     * @param driver metadata client driver
     */
    public static void registerClientDriver(String metadataBackendScheme,
                                            Class&lt;? extends MetadataClientDriver&gt; driver) {
<span class="nc" id="L171">        registerClientDriver(metadataBackendScheme, driver, false);</span>
<span class="nc" id="L172">    }</span>

    @VisibleForTesting
    public static void registerClientDriver(String metadataBackendScheme,
                                            Class&lt;? extends MetadataClientDriver&gt; driver,
                                            boolean allowOverride) {
<span class="nc" id="L178">        String scheme = metadataBackendScheme.toLowerCase();</span>
<span class="nc" id="L179">        MetadataClientDriverInfo oldDriverInfo = clientDrivers.get(scheme);</span>
<span class="nc bnc" id="L180" title="All 4 branches missed.">        if (null != oldDriverInfo &amp;&amp; !allowOverride) {</span>
<span class="nc" id="L181">            return;</span>
        }
<span class="nc" id="L183">        MetadataClientDriverInfo newDriverInfo = new MetadataClientDriverInfo(driver);</span>
<span class="nc" id="L184">        oldDriverInfo = clientDrivers.putIfAbsent(scheme, newDriverInfo);</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (null != oldDriverInfo) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L187">                log.debug(&quot;Metadata client driver for {} is already there.&quot;, scheme);</span>
            }
<span class="nc bnc" id="L189" title="All 2 branches missed.">            if (allowOverride) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L191">                    log.debug(&quot;Overriding client driver for {}&quot;, scheme);</span>
                }
<span class="nc" id="L193">                clientDrivers.put(scheme, newDriverInfo);</span>
            }
        }
<span class="nc" id="L196">    }</span>

    /**
     * Register the metadata bookie {@code driver}.
     *
     * @param metadataBackendScheme scheme of metadata backend.
     * @param driver metadata bookie driver
     */
    public static void registerBookieDriver(String metadataBackendScheme,
                                            Class&lt;? extends MetadataBookieDriver&gt; driver) {
<span class="nc" id="L206">        registerBookieDriver(metadataBackendScheme, driver, false);</span>
<span class="nc" id="L207">    }</span>

    @VisibleForTesting
    public static void registerBookieDriver(String metadataBackendScheme,
                                            Class&lt;? extends MetadataBookieDriver&gt; driver,
                                            boolean allowOverride) {
<span class="nc" id="L213">        String scheme = metadataBackendScheme.toLowerCase();</span>
<span class="nc" id="L214">        MetadataBookieDriverInfo oldDriverInfo = bookieDrivers.get(scheme);</span>
<span class="nc bnc" id="L215" title="All 4 branches missed.">        if (null != oldDriverInfo &amp;&amp; !allowOverride) {</span>
<span class="nc" id="L216">            return;</span>
        }
<span class="nc" id="L218">        MetadataBookieDriverInfo newDriverInfo = new MetadataBookieDriverInfo(driver);</span>
<span class="nc" id="L219">        oldDriverInfo = bookieDrivers.putIfAbsent(scheme, newDriverInfo);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">        if (null != oldDriverInfo) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (log.isDebugEnabled()) {</span>
<span class="nc" id="L222">                log.debug(&quot;Metadata bookie driver for {} is already there.&quot;, scheme);</span>
            }
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (allowOverride) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                if (log.isDebugEnabled()) {</span>
<span class="nc" id="L226">                    log.debug(&quot;Overriding bookie driver for {}&quot;, scheme);</span>
                }
<span class="nc" id="L228">                bookieDrivers.put(scheme, newDriverInfo);</span>
            }
        }
<span class="nc" id="L231">    }</span>

    /**
     * Retrieve the client driver for {@code scheme}.
     *
     * @param scheme the scheme for the metadata client driver
     * @return the metadata client driver
     * @throws NullPointerException when scheme is null
     */
    public static MetadataClientDriver getClientDriver(String scheme) {
<span class="nc" id="L241">        checkNotNull(scheme, &quot;Client Driver Scheme is null&quot;);</span>
<span class="nc" id="L242">        MetadataClientDriverInfo driverInfo = clientDrivers.get(scheme.toLowerCase());</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (null == driverInfo) {</span>
<span class="nc" id="L244">            throw new IllegalArgumentException(&quot;Unknown backend &quot; + scheme);</span>
        }
<span class="nc" id="L246">        return ReflectionUtils.newInstance(driverInfo.driverClass);</span>
    }

    /**
     * Retrieve the client driver for {@code uri}.
     *
     * @param uri the metadata service uri
     * @return the metadata client driver for {@code uri}
     * @throws NullPointerException if the metadata service {@code uri} is null or doesn't have scheme
     *          or there is no namespace driver registered for the scheme
     * @throws IllegalArgumentException if the metadata service {@code uri} scheme is illegal
     */
    public static MetadataClientDriver getClientDriver(URI uri) {
        // Validate the uri and load the backend according to scheme
<span class="nc" id="L260">        checkNotNull(uri, &quot;Metadata service uri is null&quot;);</span>
<span class="nc" id="L261">        String scheme = uri.getScheme();</span>
<span class="nc" id="L262">        checkNotNull(scheme, &quot;Invalid metadata service uri : &quot; + uri);</span>
<span class="nc" id="L263">        scheme = scheme.toLowerCase();</span>
<span class="nc" id="L264">        String[] schemeParts = StringUtils.split(scheme, '+');</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        checkArgument(schemeParts.length &gt; 0,</span>
                &quot;Invalid metadata service scheme found : &quot; + uri);
<span class="nc" id="L267">        return getClientDriver(schemeParts[0]);</span>
    }

    /**
     * Retrieve the bookie driver for {@code scheme}.
     *
     * @param scheme the scheme for the metadata bookie driver
     * @return the metadata bookie driver
     * @throws NullPointerException when scheme is null
     */
    public static MetadataBookieDriver getBookieDriver(String scheme) {
<span class="nc" id="L278">        checkNotNull(scheme, &quot;Bookie Driver Scheme is null&quot;);</span>
<span class="nc" id="L279">        MetadataBookieDriverInfo driverInfo = bookieDrivers.get(scheme.toLowerCase());</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (null == driverInfo) {</span>
<span class="nc" id="L281">            throw new IllegalArgumentException(&quot;Unknown backend &quot; + scheme);</span>
        }
<span class="nc" id="L283">        return ReflectionUtils.newInstance(driverInfo.driverClass);</span>
    }

    /**
     * Retrieve the bookie driver for {@code uri}.
     *
     * @param uri the metadata service uri
     * @return the metadata bookie driver for {@code uri}
     * @throws NullPointerException if the metadata service {@code uri} is null or doesn't have scheme
     *          or there is no namespace driver registered for the scheme
     * @throws IllegalArgumentException if the metadata service {@code uri} scheme is illegal
     */
    public static MetadataBookieDriver getBookieDriver(URI uri) {
        // Validate the uri and load the backend according to scheme
<span class="nc" id="L297">        checkNotNull(uri, &quot;Metadata service uri is null&quot;);</span>
<span class="nc" id="L298">        String scheme = uri.getScheme();</span>
<span class="nc" id="L299">        checkNotNull(scheme, &quot;Invalid metadata service uri : &quot; + uri);</span>
<span class="nc" id="L300">        scheme = scheme.toLowerCase();</span>
<span class="nc" id="L301">        String[] schemeParts = StringUtils.split(scheme, '+');</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">        checkArgument(schemeParts.length &gt; 0,</span>
                &quot;Invalid metadata service scheme found : &quot; + uri);
<span class="nc" id="L304">        return getBookieDriver(schemeParts[0]);</span>
    }

    /**
     * Process the provided &lt;i&gt;function&lt;/i&gt; with metadata client driver resolved
     * from the metadata service uri returned by {@link ClientConfiguration#getMetadataServiceUri()}.
     *
     * @param conf client configuration
     * @param function function to apply with metadata client driver.
     * @param executorService executor service used by the metadata client driver.
     * @throws MetadataException when failed to access metadata store
     * @throws ExecutionException exception thrown when processing &lt;tt&gt;function&lt;/tt&gt;.
     */
    @SuppressFBWarnings(&quot;RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE&quot;)
    public static &lt;T&gt; T runFunctionWithMetadataClientDriver(ClientConfiguration conf,
                                                            Function&lt;MetadataClientDriver, T&gt; function,
                                                            ScheduledExecutorService executorService)
            throws MetadataException, ExecutionException {
<span class="nc" id="L322">        try (MetadataClientDriver driver = MetadataDrivers.getClientDriver(</span>
<span class="nc" id="L323">            URI.create(conf.getMetadataServiceUri())</span>
        )) {
<span class="nc" id="L325">            driver.initialize(conf, executorService, NullStatsLogger.INSTANCE, Optional.empty());</span>
            try {
<span class="nc" id="L327">                return function.apply(driver);</span>
<span class="nc" id="L328">            } catch (Exception uee) {</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                if (uee.getCause() instanceof MetadataException) {</span>
<span class="nc" id="L330">                    throw (MetadataException) uee.getCause();</span>
                } else {
<span class="nc" id="L332">                    throw new ExecutionException(uee.getMessage(), uee.getCause());</span>
                }
            }
<span class="nc" id="L335">        } catch (ConfigurationException e) {</span>
<span class="nc" id="L336">            throw new MetadataException(Code.INVALID_METADATA_SERVICE_URI, e);</span>
        }
    }

    /**
     * Process the provided &lt;i&gt;function&lt;/i&gt; with metadata bookie driver resolved
     * from the metadata service uri returned by {@link ServerConfiguration#getMetadataServiceUri()}.
     *
     * @param conf server configuration
     * @param function function to apply with metadata bookie driver.
     * @throws MetadataException when failed to access metadata store
     * @throws ExecutionException exception thrown when processing &lt;tt&gt;function&lt;/tt&gt;.
     */
    @SuppressFBWarnings(&quot;RCN_REDUNDANT_NULLCHECK_WOULD_HAVE_BEEN_A_NPE&quot;)
    public static &lt;T&gt; T runFunctionWithMetadataBookieDriver(ServerConfiguration conf,
                                                            Function&lt;MetadataBookieDriver, T&gt; function)
            throws MetadataException, ExecutionException {
<span class="nc" id="L353">        try (MetadataBookieDriver driver = MetadataDrivers.getBookieDriver(</span>
<span class="nc" id="L354">            URI.create(conf.getMetadataServiceUri())</span>
        )) {
<span class="nc" id="L356">            driver.initialize(conf, NullStatsLogger.INSTANCE);</span>
            try {
<span class="nc" id="L358">                return function.apply(driver);</span>
<span class="nc" id="L359">            } catch (Exception uee) {</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">                if (uee.getCause() instanceof MetadataException) {</span>
<span class="nc" id="L361">                    throw (MetadataException) uee.getCause();</span>
                } else {
<span class="nc" id="L363">                    throw new ExecutionException(uee.getMessage(), uee.getCause());</span>
                }
            }
<span class="nc" id="L366">        } catch (ConfigurationException e) {</span>
<span class="nc" id="L367">            throw new MetadataException(Code.INVALID_METADATA_SERVICE_URI, e);</span>
        }
    }

    /**
     * Process the provided &lt;i&gt;function&lt;/i&gt; with registration manager resolved
     * from the metadata service uri returned by {@link ServerConfiguration#getMetadataServiceUri()}.
     *
     * @param conf server configuration
     * @param function function to apply with registration manager.
     * @throws MetadataException when failed to access metadata store
     * @throws ExecutionException exception thrown when processing &lt;tt&gt;consumer&lt;/tt&gt;.
     */
    public static &lt;T&gt; T runFunctionWithRegistrationManager(ServerConfiguration conf,
                                                           Function&lt;RegistrationManager, T&gt; function)
            throws MetadataException, ExecutionException {
<span class="nc" id="L383">        return runFunctionWithMetadataBookieDriver(</span>
                conf, driver -&gt; {
<span class="nc" id="L385">                    try (RegistrationManager rm = driver.createRegistrationManager()) {</span>
<span class="nc" id="L386">                        return function.apply(rm);</span>
                    }
                });
    }

    /**
     * Process the provided &lt;i&gt;function&lt;/i&gt; with ledger manager factory resolved
     * from the metadata service uri returned by {@link ServerConfiguration#getMetadataServiceUri()}.
     *
     * @param conf server configuration
     * @param function function to apply with ledger manager factory.
     * @throws MetadataException when failed to access metadata store
     * @throws ExecutionException exception thrown when processing &lt;tt&gt;consumer&lt;/tt&gt;.
     */
    public static &lt;T&gt; T runFunctionWithLedgerManagerFactory(ServerConfiguration conf,
                                                            Function&lt;LedgerManagerFactory, T&gt; function)
            throws MetadataException, ExecutionException {
<span class="nc" id="L403">        return runFunctionWithMetadataBookieDriver(conf, driver -&gt; {</span>
            try {
<span class="nc" id="L405">                return function.apply(driver.getLedgerManagerFactory());</span>
<span class="nc" id="L406">            } catch (MetadataException me) {</span>
<span class="nc" id="L407">                throw new UncheckedExecutionException(me.getMessage(), me);</span>
            }
        });
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>